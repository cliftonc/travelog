<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta name="generator" content="HTML Tidy for Windows (vers 14 February 2006), see www.w3.org" />
<title>Testing</title>
<script type="text/javascript" src="/mdb/js/jquery-1.4.2.min.js">
</script>
<script type="text/javascript" src="/mdb/js/jquery.layout.min-1.2.0.js">
</script>
<script type="text/javascript" src="/mdb/js/jquery-ui-1.8.custom.min.js">
</script>
<script type="text/javascript" src="http://maps.google.co.uk/maps?file=api&v=2&key=ABQIAAAAtN4hECGudqg6epgOA2ksuBRTuAA4jwnjEFdxJeOOthBDmzmzlBR2rYXU8_Qw4xI1UGWOcyhsHIuRKQ">
</script>
<link rel="stylesheet" type="text/css" href="/mdb/css/dark-hive/jquery-ui-1.8.custom.css" />
<style media="screen" type="text/css">
	body { background-color: #000; color: white; font-size: 11px;padding-left: 5px; padding-right: 5px; font-family: verdana; }   
	label { padding-bottom: 4px; }
    .list { list-style:none; padding:0; font-size:11px;font-face: arial;}
    .list li { whitespace: nowrap; padding:3px; }
	.list li span { width: 70px; }
    .list li:hover { background:#555; color:#fff; cursor:pointer; cursor:hand; }
	button { width: 100% }
    #showall { background:#343434; color: white;}
	div.input { padding:3px 0; }
	label { display:block; font-size:80%; }
	input, select { width: 100%; }	
	div.error { color:red; font-weight:bold; }		
	#directions { overflow: auto }
	#east-tabs-1 { overflow: auto }
	#east-tabs-2 { overflow: auto }
	#list { font-size: 10px; overflow: auto }
	#list div { padding: 3px; cursor:pointer; cursor:hand; border-bottom: solid 1px silver; }
	#list div:hover { background:#eee; color:#115511; cursor:pointer; cursor:hand; }
	.ui-tabs-disabled {
		display: none; /* disabled tabs don't show up */
	} 
	.ui-layout-pane-west-open {
		width: 250px;
	}
	
</style>

<script type="text/javascript">

var bounds = new GLatLngBounds();
var geo = new GClientGeocoder(); 
				
var reasons=[];
reasons[G_GEO_SUCCESS]            = "Success";
reasons[G_GEO_MISSING_ADDRESS]    = "Missing Address";
reasons[G_GEO_UNKNOWN_ADDRESS]    = "Unknown Address.";
reasons[G_GEO_UNAVAILABLE_ADDRESS]= "Unavailable Address";
reasons[G_GEO_BAD_KEY]            = "Bad API Key";
reasons[G_GEO_TOO_MANY_QUERIES]   = "Too Many Queries";
reasons[G_GEO_SERVER_ERROR]       = "Server error";

$(document).ready(function(){

	$('body').layout({ 
			// applyDefaultStyles: false,
			closable:  false,
			resizable: true,
			east__size: 300
	});

	function resizeUi() {
		var h = $(window).height();
		var w = $(window).width();
		$("#tabs").css('height', h-65 );
		$("#center-tabs").css('height', h-65 );
		$("#east-tabs").css('height', h-65 );
		$("#map").css('height', h-125 );
		$("#directions").css('height', h-125 );
		$("#list").css('height', h-125 );
		$(".ui-tabs-panel").css('height', h-125 );
		$('#east-tabs-2').css('height', h-125 );
		$('#east-tabs-1').css('height', h-125 );
	};

	var resizeTimer = null;
	$(window).bind('resize', function() {
		if (resizeTimer) clearTimeout(resizeTimer);
		resizeTimer = setTimeout(resizeUi, 100);
	});
	resizeUi();

	
	$("button").button();
	
	$(".ui_tabs").tabs();	
	
    var map = new GMap2(document.getElementById('map'),{ });
	map.setUIToDefault();
	var Tsize = new GSize(124, 124);
	map.addControl(new GOverviewMapControl(Tsize));


	// Create a base icon for all of our markers that specifies the
	// shadow, icon dimensions, etc.
	var baseIcon = new GIcon(G_DEFAULT_ICON);
	baseIcon.shadow = "http://google-maps-icons.googlecode.com/files/shadow.png";
	baseIcon.iconSize = new GSize(24, 28);
	baseIcon.shadowSize = new GSize(42,28);
	baseIcon.iconAnchor = new GPoint(13, 30);
	baseIcon.infoWindowAnchor = new GPoint(9, 2);
     
	loadLocations();
	loadRoutes();
	
	  
    $("#message").appendTo(map.getPane(G_MAP_FLOAT_SHADOW_PANE));
    
	$("#add-point").submit(function(){
		geoEncode();
		return false;
	});
	
	$("#add-route").submit(function(){		
		saveRoute();
		return false;
	});
	
	function loadLocations() {
		
		$('#directions').empty();			
		$('#list').empty();					
		$('#center-tabs').tabs('disable', 3); 
		map.clearOverlays();
		$('#location_list').empty();
		$('.location_select').empty();
		
		var type = $("#select-location-type").val();
		
		$.getJSON("location/jsonlist/"+type, function(json) {
			// do stuff in step #11		
			if (json.Locations.length > 0) {
				for (i=0; i<json.Locations.length; i++) {			    
					var location = json.Locations[i];				
					addLocation(location);				
				}
				zoomToBounds();
			}
		});
	
	}
	
	function editLocation(locationId) {
		
		$.getJSON("location/show/"+locationId, function(json) {
			// do stuff in step #11		
			if (json.status = "success" ) {
				$('#add-point #location_id').val(json.data.id);
				$('#add-point #name').val(json.data.name);
				$('#add-point #address').val(json.data.address);
				$('#add-point #url').val(json.data.url);
				$('#add-point #phone').val(json.data.phone);
				$('#add-point #type').val(json.data.type);
				$('#form-add-point').dialog('open');
			}
		});
		
	}
	
	function deleteLocation(locationId) {
		
		$.getJSON("location/delete/"+locationId, function(json) {
			// do stuff in step #11		
			if (json.status = "success" ) {
				 loadLocations();
			}
		});
		
	}
	
	function editRoute(routeId) {
		
		$.getJSON("route/show/"+routeId, function(json) {
			// do stuff in step #11		
			if (json.status = "success" ) {
				$('#add-route #route_id').val(json.data.id);
				$('#add-route #description').val(json.data.description);
				$('#add-route #start_location_id').val(json.data.start_location_id);
				$('#add-route #end_location_id').val(json.data.end_location_id);
				$('#form-add-route').dialog('open');
			}
		});
		
	}
	
	function deleteRoute(routeId) {
		
		
		$.getJSON("route/delete/"+routeId, function(json) {
			// do stuff in step #11		
			if (json.status = "success" ) {
				 loadRoutes();
			}
		});
		
	}
	
	function loadRoutes() {
		$('#route_list').empty();
		$.getJSON("route/jsonlist", function(json) {
			// do stuff in step #11		
			if (json.Routes.length > 0) {
				for (i=0; i<json.Routes.length; i++) {			    
					var route = json.Routes[i];				
					addRoute(route);
				}
			}
		});
	}
	
	function showDirections(route) {
	
		map.clearOverlays();
		$('#center-tabs').tabs('enable', 3); 
	
		$.getJSON("route/jsonroute/" + route.id, function(json) {
			// do stuff in step #11		
			 var  directionsPanel = document.getElementById("directions");
			 $('#directions').empty();
			directions = new GDirections(map,directionsPanel);
			directions.load("from: " + json.start_location + " to: " + json.end_location);					
		});
			 
	}
	
function displayPoint(marker, index){
    $("#message").hide();    
    var moveEnd = GEvent.addListener(map, "moveend", function(){
        var markerOffset = map.fromLatLngToDivPixel(marker.getLatLng());
        $("#message")
            .fadeIn()
            .css({ top:markerOffset.y, left:markerOffset.x });  
        GEvent.removeListener(moveEnd);
    });
    map.panTo(marker.getLatLng());
}   

function geoEncode() {
	var address = $("#add-point input[name=address]").val();
	geo.getLocations(address, function (result){
		if (result.Status.code == G_GEO_SUCCESS) {
			geocode = result.Placemark[0].Point.coordinates;
			savePoint(geocode);
		} else {
			var reason="Code "+result.Status.code;
			if (reasons[result.Status.code]) {
				reason = reasons[result.Status.code]
			} 
			$("#add-point .error").html(reason).fadeIn();
			geocode = false;
		}
	});
}

function savePoint(geocode) {
	var data = $("#add-point :input").serializeArray();
	data[data.length] = { name: "lng", value: geocode[0] };
	data[data.length] = { name: "lat", value: geocode[1] };
	$.post($("#add-point").attr('action'), data, function(json){
		$("#add-point .error").fadeOut();
		if (json.status == "fail") {
			$("#add-point .error").html(json.message).fadeIn();
		}
		if (json.status == "success") {
			$("#add-point :input[name!=action]").val("");
			var location = json.data;
			loadLocations();
		}
	}, "json");
}

function saveRoute() {
	var data = $("#add-route :input,select").serializeArray();	
	$.post($("#add-route").attr('action'), data, function(json){
		$("#add-route .error").fadeOut();
		if (json.status == "fail") {
			$("#add-route .error").html(json.message).fadeIn();
		}
		if (json.status == "success") {
			$("#add-route :input[name!=action]").val("");
			var route = json.data;
			loadRoutes();
		}
	}, "json");
}

function addLocation(location) {
		
	var point = new GLatLng(location.lat, location.lng);		
	
	 // Create a lettered icon for this point using our icon class   
   var letteredIcon = new GIcon(baseIcon);
   // letteredIcon.image = "http://www.google.com/mapfiles/marker" +  String.fromCharCode(location.type.charCodeAt(0))  + ".png";

   if(location.type == "Restaurant") {
	letteredIcon.image = "http://google-maps-icons.googlecode.com/files/restaurant.png";
	}
   if(location.type == "Accomodation") {
	letteredIcon.image = "http://google-maps-icons.googlecode.com/files/villa.png";
	}
	if(location.type == "Booked") {
	letteredIcon.image = "http://google-maps-icons.googlecode.com/files/home.png";
	}	
	if(location.type == "Camping") {
	letteredIcon.image = "http://google-maps-icons.googlecode.com/files/tent.png";
	}	
	if(location.type == "POI") {
	letteredIcon.image = "http://google-maps-icons.googlecode.com/files/info.png";
	}	
   
   // Set up our GMarkerOptions object
   markerOptions = { icon:letteredIcon };

	 var marker = new GMarker(point, markerOptions);
	
	 GEvent.addListener(marker, "click", function() {
        marker.openInfoWindowHtml( location.name + '<br/>'  + location.address +'<br/><a target="_new" href="'  + location.url + '">'+ location.url +'</a><br/>' + location.phone);
      });
      map.addOverlay(marker);	
	  bounds.extend(marker.getPoint());
	
	$("<li>")
		.html('<div class="show_location" id="showlocation_' + location.id+'" title="Show"><div style="float: left; width: 100px;">' + location.name + '</div><a style="float: right" class="delete_location" id="deletelocation_' + location.id+'" title="Delete"><img src="css/delete.png" border="0"/></a><a style="float: right" class="edit_location" id="editlocation_' + location.id+'" title="Edit"><img src="css/edit.png" border="0"/></a><div style="clear:both"/></div>')
		.appendTo("#location_list");

	$("#showlocation_" + location.id)
		.click(function(){
			showMarker(marker);
		})		
	
	$("#deletelocation_" + location.id)
		.click(function(){
			deleteLocation(location.id);
	})
	
	$("#editlocation_" + location.id)
		.click(function(){
			editLocation(location.id);
	})	
	
	$("<div>")
		.html("<h3>" + location.name + "</h3><b>Address: </b>" + location.address + ", <b>Phone:</b>" + location.phone + "<br/><b>URL:&nbsp;</b><a target='_new' href='" + location.url + "'>" + location.url + "</a>")
		.click(function(){
			showMarker(marker);
		})
		.appendTo("#list");	
	
	$("<option>")
		.html(location.name)
		.val(location.id)
		.appendTo(".location_select");
	
	
	GEvent.addListener(marker, "click", function(){
		showMarker(this);
	});
}

function addRoute(route) {
		
	//var point = new GLatLng(location.lat, location.lng);		
	//var marker = new GMarker(point);	
	 //GEvent.addListener(marker, "click", function() {
     //   marker.openInfoWindowHtml( location.name + '<br/>'  + location.address +'<br/><a target="_new" href="'  + location.url + '">'+ location.url +'</a><br/>' + location.phone);
     // });
     // map.addOverlay(marker);	
	//bounds.extend(marker.getPoint());
	
	$("<li>")
		.html('<div class="show_route" id="showroute_' + route.id+'" title="Show"><div style="float: left; width: 100px;">' + route.description + '</div><a style="float: right" class="delete_route" id="deleteroute_' + route.id+'" title="Delete"><img src="css/delete.png" border="0"/></a><a style="float: right" class="edit_route" id="editroute_' + route.id+'" title="Edit"><img src="css/edit.png" border="0"/></a><div style="clear:both"/></div>')		
		.appendTo("#route_list");
	
	$("#showroute_" + route.id)
		.click(function(){
			// showMarker(marker);
			showDirections(route);
		})
	
	$("#deleteroute_" + route.id)
		.click(function(){
			deleteRoute(route.id);
	})
	
	$("#editroute_" + route.id)
		.click(function(){
			editRoute(route.id);
	})	
	
	//GEvent.addListener(marker, "click", function(){
	//	showMarker(this);
	//});
}

$("#message").appendTo( map.getPane(G_MAP_FLOAT_SHADOW_PANE) );
				
function showMarker(marker){
	$('#center-tabs').tabs('select', 0);
	var markerOffset = map.fromLatLngToDivPixel(marker.getPoint());
	// map.panTo(marker.getLatLng());		
	map.setCenter(marker.getLatLng(),11);
}

function zoomToBounds() {
	map.setCenter(bounds.getCenter());
	map.setZoom(map.getBoundsZoomLevel(bounds));
}

	$("#showall")		
		.click(function(){
			loadLocations();
		});
		
		$("#select-location-type")		
		.change(function(){
			loadLocations();
		});

	  $("#form-add-point").dialog({
			autoOpen: false,
			height: 320,
			width: 350,
			modal: true,
			title: 'Add New Location',
			buttons: {
				'Save Location': function() {					
					geoEncode();
					$(this).dialog('close');
				},
				Cancel: function() {
					$(this).dialog('close');
				}
			},
			close: function() {
				// 
			}
		});
		
		
	  $("#form-add-route").dialog({
			autoOpen: false,
			height: 230,
			width: 350,
			title: 'Add New Route',
			modal: true,
			buttons: {
				'Save Route': function() {					
						saveRoute();
						$(this).dialog('close');
				},
				Cancel: function() {
					$(this).dialog('close');
				}
			},
			close: function() {
				// 
			}
		});

		$('#show-form-add-point')
			.button()
			.click(function() {
				$('#add-point #location_id').val("");
				$('#add-point #name').val("");
				$('#add-point #address').val("");
				$('#add-point #url').val("");
				$('#add-point #phone').val("");				
				$('#add-point #type').val("Accomodation");				
				$('#form-add-point').dialog('open');
			});
		
		$('#show-form-add-route')
			.button()
			.click(function() {
				$('#add-route #route_id').val("");
				$('#add-route #description').val("");
				$('#form-add-route').dialog('open');
			});
		
});

</script>
</head>
<body>
<DIV class="ui-layout-north">
	<div style="height: 35px; padding-top: 10px; padding-left: 10px;font-size: 15px; font-weight: bold;">A Metaphorical Deep Breath<br/><font style="font-weight: normal;font-size: 10px">Trip Planner</font></div>
</DIV>
<DIV class="ui-layout-center">
<div class="ui_tabs" id="center-tabs">
	<ul>
		<li><a href="#map">Map</a></li>		
		<li><a href="#list">Location List</a></li>				
		<li><a href="#journal">Journal</a></li>				
		<li><a href="#directions">Directions</a></li>				
	</ul>
	<div id="map">
	</div>
	<div id="directions">
	</div>	
	<div id="list">
	</div>	
	<div id="journal">
	</div>	
</div>
</DIV>

<DIV class="ui-layout-west">
<div class="ui_tabs"  id="east-tabs">
<ul>
		<li><a href="#east-tabs-1" title='Locations'><img src='http://google-maps-icons.googlecode.com/files/home.png' style="height: 20px; border: 0; margin-bottom: -5px;"/></a></li>				
		<li><a href="#east-tabs-2" title='Routes'><img src='http://google-maps-icons.googlecode.com/files/right.png' style="height: 20px; border: 0; margin-bottom: -5px;"/></a></li>		
		<li><a href="#east-tabs-3" title='Admin'><img src='http://google-maps-icons.googlecode.com/files/mine.png' style="height: 20px; border: 0; margin-bottom: -5px;"/></a></li>		
	</ul>
<div id="east-tabs-1" >
<select id="select-location-type">
			<option SELECTED>All</option>
			<option>Accomodation</option>
			<option>Booked</option>
			<option>Restaurant</option>
			<option>Camping</option>
			<option>POI</option>
</select>
<ul class='list' id="location_list">
</ul>
<button id="show-form-add-point"><img src='http://google-maps-icons.googlecode.com/files/home.png' style="height: 20px; border: 0; margin-bottom: -5px;"/>&nbsp;Add Location</button>
</div>
<div id="east-tabs-2">
<ul class='list' id="route_list">
</ul>
<button id="show-form-add-route"><img src='http://google-maps-icons.googlecode.com/files/right.png' style="height: 20px; border: 0; margin-bottom: -5px;"/>&nbsp;Add Route</button>
</div>
<div id="east-tabs-3">
<ul class='list' id="util_list">
	<li id='showall'>Reset Map</li>
</ul>
</div>
</div>
</DIV>
<!--- Forms -->
	<div id="form-add-point">
		<form id="add-point" action="location/save" method="POST">				
				<input type="hidden" name="location_id" value="" id="location_id">
				<div class="error" style="display:none;"></div>
				<div class="input">
					<label for="name">Location Name</label>
					<input type="text" name="name" id="name" value="">
				</div>
				<div class="input">
					<label for="address">Address</label>
					<input type="text" name="address" id="address" value="">
				</div>
				<div class="input">
					<label for="url">URL</label>
					<input type="text" name="url" id="url" value="">
				</div>
				<div class="input">
					<label for="phone">Phone No</label>
					<input type="text" name="phone" id="phone" value="">
				</div>			
				<div class="input">
						<label for="type">Type</label>
						<select class="type_select" name="type" id="type">
							<option SELECTED>Accomodation</option>
							<option>Booked</option>
							<option>Restaurant</option>
							<option>Camping</option>
							<option>POI</option>
						</select>			
					</div>												
		</form>		
		</div>
	
	<div id="form-add-route">
			<form id="add-route" action="route/save" method="POST">
					<input type="hidden" name="route_id" value="" id="route_id">
					<div class="error" style="display:none;"></div>
					<div class="input">
						<label for="description">Description</label>
						<input type="text" name="description" id="description" value="">
					</div>
					<div class="input">
						<label for="start_location_id">Start</label>
						<select class="location_select" name="start_location_id" id="start_location_id">
						</select>
					</div>
					<div class="input">
						<label for="end_location_id">End</label>
						<select class="location_select" name="end_location_id" id="end_location_id">
						</select>			
					</div>								
			</form>			
			</div>
	
</body>
</html>

